=====0.5x=====


  * Создан новый модуль [[abills:docs:modules:multidoms:ru:abills|Multidoms]]. Система управления мультидоменами, разрешающая независимо вести в одной биллинговой системе несколько провайдеров.
  * Добавлен интерфейс реселлера, с возможностью авторегистрации реселлеров.
  * Улучшен интерфейс дилера в карточном модуле. Доработаны отчёты продаж
  * Добавлены поля занесения физических адресов расположения серверов доступа  
  * Вынесены классы трафика в отдельную форму и доработан шейпер с учётом таблиц FreeBSD + ng_car. **При миграции нужно завести классы трафика в таблицу и повторно их выбрать в форме тарификации трафика**
  * Добавлена возможность учёта классов трафика для MPD5 через RADIUS  атрибуты
  * Добавлена возможность мониторинга нескольких баз данных, мониторинг состояния кластера
  * Добавлена возможность вести историю SQL  запросов в Sqlcmd
  * Добавлена возможность задавать несколько расписаний на изменение тарифных планов.
  * Добавлены поля максимальное количество трафика и времени для тарифного плана. Позволяет более гибко стоить тарифных планы для Hotspot систем.
  * Добавлено группирование NAS (серверов доступа).
  * Задание минимального размер пакета, который будет попадать в детализацию. Данная опция предохраняет от замусоривания базы $conf{IPN_DETAIL_MIN_SIZE}=1024;
  * Добавлено в компании информационное поле представитель
  * Добавлена привязка платежей к платёжным документам: счёт, счёт-фактура, кассовый ордер
  * Добавлена возможность автоконфигурации точек HotSpot с прошивкой на базе WRT
  * Добавлена возможность добавлять комментарии при назначении периодических платежей пользователям. Комментарии отображаются при снятии денег по периодическим платежам.
  * Добавлено отображение даты следующего периодического платежа
  * Добавлены временные интервалы к периодическим платежам: квартал, пол года
  * Добавлена возможность снимать деньги с дополнительного счёта
  * Добавлены возможность производить снятия как по фиксированным периодам: начало месяца, начало квартала начало года, так и по произвольным - через месяц после последнего снятия, через квартал, через полгода, через год
  * Добавлено в отчёты Extfin  возможность выбора статистики отдельно по юридическим или физическим пользователям.
  * В модуль Cards добавлена опция $conf{CARDS_BRUTE_CLEAN_PERIOD}=2; - количество дней через которое удаляется запись о неправильном вводе пин-кода. (По умолчанию 2 дня).
  * Доработана возможность изменения кредита с пользовательского интерфейса. Добавлена возможность задавать количество изменений в месяц.
  * Добавлена возможность задавать минимальное допустимое количество символов при поиске логинов администратором
  * Добавлена возможность ограничить количество значений отображаемых в списках администратором. Настраивается в веб интерфейсе администратора.
  * Добавлена возможность удалять Vlan.
  * Сделана возможность переинициализировать Vlan  на удалённых серверах доступа после их перезагрузки
  * Добавлена возможность задавать несколько MAC адресов пользователю.
  * Добавлена возможность авто. выбора следующего свободного статического адреса из пула для модуля Dv. Выбираются адреса только из пулов с флагом STATIC.
  * Добавлена возможность авто. выбора следующего свободного статического адреса для модуля Dhcphosts.
  * Создание актов оказания услуг. Автоматическое создание актов оказания услуг за прошедший период.
  * Разделение выписки счетов отдельно для юридических лиц и для физических.
  * Добавлена опция $conf{SNMPUTILS_BINDING_DEPOSIT}=0.	Количество средств на счету ниже которого не привязываетя пользователь к портам комутатора. Количество средств - Депозит + Кредит аккаунта пользователя. 
  * Новая опция $conf{DV_USER_SERVICE_HOLDUP}=1; 	 Приостановка действия сервиса пользователя из личного кабинета кабинета.   
  * Добавлен параметр $conf{LANGS} разрешающий добавлять собственные словари и работать только с нужными языками.

  ALTER TABLE users ADD column domain_id smallint(6) unsigned not null default 0;
  ALTER TABLE users DROP index id;
  ALTER TABLE users ADD UNIQUE KEY `id` (id, domain_id);
  
  ALTER TABLE groups ADD column `domain_id` smallint(6) unsigned not null default 0;
  ALTER TABLE groups DROP index name;
  ALTER TABLE groups ADD UNIQUE KEY `name` (`domain_id`, `name`);
  
  
  ALTER TABLE companies ADD column `domain_id` smallint(6) unsigned not null default 0;
  ALTER TABLE companies DROP index name;
  ALTER TABLE companies ADD UNIQUE KEY `name` (`domain_id`, `name`);
  
  ALTER TABLE tarif_plans ADD column `domain_id` smallint(6) unsigned not null default 0;
  ALTER TABLE tarif_plans DROP KEY id;
  ALTER TABLE tarif_plans ADD UNIQUE  KEY `id` (`id`, `module`, `domain_id`);
  
  
  ALTER TABLE tarif_plans DROP KEY `name`;
  ALTER TABLE tarif_plans ADD UNIQUE KEY `name` (`name`, `domain_id`);
  
  ALTER TABLE admins ADD column `domain_id` smallint(6) unsigned not null default 0;
  
  ALTER TABLE nas ADD column `domain_id` smallint(6) unsigned not null default 0;
  ALTER TABLE nas ADD column `address_street` varchar(100) NOT NULL default '';
  ALTER TABLE nas ADD column `address_build` varchar(10) NOT NULL default '';
  ALTER TABLE nas ADD column `address_flat` varchar(10) NOT NULL default '';
  ALTER TABLE nas ADD column `zip` varchar(7) NOT NULL default '';
  ALTER TABLE nas ADD column `city` varchar(20) NOT NULL default '';
  
  ALTER TABLE cards_users ADD column `domain_id` smallint(6) unsigned not null default 0;
  ALTER TABLE cards_users DROP index serial;
  ALTER TABLE cards_users ADD KEY `serial` (`number`,`serial`, `domain_id`);
  
  
  ALTER TABLE cards_users ADD KEY `domain_id` (`domain_id`);
  ALTER TABLE cards_users ADD column `created` DATETIME NOT NULL;
  UPDATE cards_users SET created=datetime;
  
  ALTER TABLE cards_bruteforce ADD column `domain_id` smallint(6) unsigned not null default 0;
  
  CREATE TABLE `domains` (
    `id` SMALLINT(6) UNSIGNED NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(30) NOT NULL DEFAULT '',
    `comments` TEXT NOT NULL,
    `created` DATE NOT NULL,
    `state` TINYINT(1) UNSIGNED NOT NULL DEFAULT '0',
    PRIMARY KEY (`id`),
    UNIQUE KEY `name` (`name`)
  )  COMMENT='Domains List';
  
  ALTER TABLE intervals add column new_tp_id smallint unsigned not null default 0;
  UPDATE intervals, tarif_plans SET intervals.new_tp_id=tarif_plans.tp_id
  WHERE intervals.tp_id=tarif_plans.id;
  ALTER TABLE  intervals drop KEY tp_intervals;
  DELETE from intervals WHERE new_tp_id=0;
  UPDATE intervals SET intervals.tp_id=new_tp_id;
  ALTER TABLE intervals add UNIQUE KEY `tp_intervals` (`tp_id`, `begin`, `day`);
  ALTER TABLE intervals drop column new_tp_id;
  DELETE FROM tp_nas;  
  
  CREATE TABLE `traffic_classes` (
    `id` SMALLINT(6) UNSIGNED NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(25) COLLATE latin1_swedish_ci NOT NULL DEFAULT '',
    `nets` TEXT COLLATE latin1_swedish_ci,
    `comments` TEXT COLLATE latin1_swedish_ci NOT NULL,
    PRIMARY KEY (`id`),
    UNIQUE KEY `id` (`id`),
    UNIQUE KEY `name` (`name`)
   ) COMMENT='Traffic Classes';
  
  INSERT INTO traffic_classes (name, nets) VALUES ('Global', '0.0.0.0/0');
  
  ALTER TABLE trafic_tarifs ADD COLUMN `net_id` SMALLINT(6) UNSIGNED NOT NULL DEFAULT '0';
  
  CREATE TABLE `sqlcmd_history` (
    `id` INTEGER(11) UNSIGNED NOT NULL AUTO_INCREMENT,
    `datetime` DATETIME NOT NULL,
    `aid` SMALLINT(6) UNSIGNED NOT NULL DEFAULT '0',
    `sql_query` TEXT NOT NULL,
    `db_id` TINYINT(4) UNSIGNED NOT NULL DEFAULT '0',
    `comments` TEXT NOT NULL,
    PRIMARY KEY (`id`),
    UNIQUE KEY `id` (`id`),
    KEY `aid` (`aid`)
  ) COMMENT='Sqlcmd history';
  
  ALTER TABLE cards_dillers ADD COLUMN `tp_id` SMALLINT(6) UNSIGNED NOT NULL DEFAULT '0';
  
  CREATE TABLE `dillers_tps` (
    `id` SMALLINT(6) UNSIGNED NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(100) COLLATE latin1_swedish_ci NOT NULL DEFAULT '',
    `payment_type` TINYINT(2) UNSIGNED NOT NULL DEFAULT '0',
    `percentage` TINYINT(3) UNSIGNED NOT NULL DEFAULT '0',
    `operation_payment` DOUBLE(14,2) UNSIGNED NOT NULL DEFAULT '0.00',
    `activate_price` DOUBLE(14,2) UNSIGNED NOT NULL DEFAULT '0.00',
    `change_price` DOUBLE(14,2) UNSIGNED NOT NULL DEFAULT '0.00',
    `credit` DOUBLE(10,2) UNSIGNED NOT NULL DEFAULT '0.00',
    `min_use` DOUBLE(14,3) UNSIGNED NOT NULL DEFAULT '0.000',
    `payment_expr` VARCHAR(240) COLLATE latin1_swedish_ci NOT NULL DEFAULT '',
    `nas_count` SMALLINT(6) UNSIGNED NOT NULL DEFAULT 0,
    `tp_counts` SMALLINT(6) UNSIGNED NOT NULL DEFAULT 0,
    PRIMARY KEY (`id`),
    UNIQUE KEY `id` (`id`),
    UNIQUE KEY `name` (`name`)
   ) COMMENT='Resellers Tarif Plans';
  
  ALTER TABLE tarif_plans ADD COLUMN `total_time_limit` INTEGER(11) UNSIGNED NOT NULL DEFAULT '0';
  ALTER TABLE tarif_plans ADD COLUMN `total_traf_limit` INTEGER(11) UNSIGNED NOT NULL DEFAULT '0';
  
  ALTER TABLE nas ADD COLUMN`gid` smallint(6) unsigned NOT NULL default 0;
  
  CREATE TABLE `nas_groups` (
    `id` int(10) unsigned NOT NULL auto_increment,
    `name` varchar(40) NOT NULL default '',
    `comments` text not null,
    `disable` tinyint(6) unsigned NOT NULL default '0',
    `domain_id` smallint(6) unsigned not null default 0,
    PRIMARY KEY  (`id`),
    UNIQUE KEY `domain_id` (`domain_id`,`name`)
  ) COMMENT='Nas servers groups';
  
  ALTER TABLE companies ADD COLUMN `representative` VARCHAR(120) NOT NULL DEFAULT '';
  
  ALTER TABLE docs_acct ADD COLUMN `payment_id` int(11) unsigned NOT NULL default 0;
  ALTER TABLE docs_acct ADD COLUMN `domain_id` smallint(6) unsigned not null default 0;
  ALTER TABLE docs_acct ADD KEY `payment_id` (`payment_id`);
  ALTER TABLE docs_acct ADD KEY `domain_id` (`domain_id`);
  ALTER TABLE docs_invoice ADD COLUMN `payment_id` int(11) unsigned NOT NULL default 0;
  ALTER TABLE docs_invoice ADD COLUMN `domain_id` smallint(6) unsigned not null default 0;
  ALTER TABLE docs_invoice ADD KEY `payment_id` (`payment_id`);
  ALTER TABLE docs_invoice ADD KEY `domain_id` (`domain_id`);
  CREATE TABLE `docs_tax_invoices` (
    `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
    `date` date NOT NULL DEFAULT '0000-00-00',
    `created` datetime NOT NULL DEFAULT '0000-00-00 00:00:00',
    `tax_invoice_id` int(10) unsigned NOT NULL DEFAULT '0',
    `uid` int(11) unsigned NOT NULL DEFAULT '0',
    `aid` smallint(6) unsigned NOT NULL DEFAULT '0',
    `vat` double(5,2) unsigned NOT NULL DEFAULT '0.00',
    `company_id` int(11) unsigned NOT NULL DEFAULT '0',
    `domain_id` smallint(6) unsigned not null default 0,
    PRIMARY KEY (`id`),
    UNIQUE KEY `date` (`date`,`company_id`),
    KEY `domain_id` (`domain_id`)
  ) COMMENT='Docs Tax Invoices';  
    
  ALTER TABLE nas ADD COLUMN `country` tinyint(6) unsigned NOT NULL default '0';
  ALTER TABLE nas ADD COLUMN `mac` varchar(17) NOT NULL default '';
  ALTER TABLE nas ADD COLUMN `changed` datetime NOT NULL default '0000-00-00 00:00:00';
  
  ALTER TABLE abon_user_list ADD COLUMN `comments` VARCHAR(240) COLLATE cp1251_general_ci NOT NULL DEFAULT '';
  ALTER TABLE abon_user_list ADD KEY `uid` (`uid`, `tp_id`);
  ALTER TABLE abon_tariffs CHANGE COLUMN name `name` varchar(100) NOT NULL default '';
  ALTER TABLE abon_tariffs ADD COLUMN `ext_bill_account` tinyint(1) unsigned NOT NULL DEFAULT '0';
  ALTER TABLE abon_tariffs ADD COLUMN `nonfix_period` tinyint(1) unsigned NOT NULL DEFAULT '0';
  UPDATE tarif_plans SET module='Dv' WHERE module='';
  ALTER TABLE `admins` ADD COLUMN min_search_chars tinyint(2) unsigned NOT NULL DEFAULT '0';
  ALTER TABLE `admins` ADD COLUMN max_rows smallint(6) unsigned NOT NULL DEFAULT '0';
  ALTER TABLE `ippools` ADD COLUMN static tinyint(6) unsigned NOT NULL DEFAULT '0';
  UPDATE dv_main SET CID='ANY' WHERE CID='0';
  
  CREATE TABLE `docs_acts` (
    `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
    `date` date NOT NULL DEFAULT '0000-00-00',
    `created` datetime NOT NULL DEFAULT '0000-00-00 00:00:00',
    `act_id` int(10) unsigned NOT NULL DEFAULT '0',
    `uid` int(11) unsigned NOT NULL DEFAULT '0',
    `aid` smallint(6) unsigned NOT NULL DEFAULT '0',
    `vat` double(5,2) unsigned NOT NULL DEFAULT '0.00',
    `company_id` int(11) unsigned NOT NULL DEFAULT '0',
    `domain_id` smallint(6) unsigned not null default 0,
    `sum` double(10,2) unsigned NOT NULL default '0.00',
    PRIMARY KEY (`id`),
    UNIQUE KEY `date` (`date`,`company_id`),
    KEY `domain_id` (`domain_id`)
  ) COMMENT='Docs Acts';
  
  ALTER TABLE nas_groups ADD COLUMN `default` TINYINT(1) UNSIGNED NOT NULL DEFAULT '0';
  ALTER TABLE nas_groups ADD COLUMN `main_page` VARCHAR(120) NOT NULL DEFAULT '';
  ALTER TABLE tarif_plans ADD COLUMN `priority` tinyint(1) unsigned NOT NULL  DEFAULT '0';
  ALTER TABLE users_pi ADD COLUMN `contract_sufix` VARCHAR(5) NOT NULL DEFAULT '';
